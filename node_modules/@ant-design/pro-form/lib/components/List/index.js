"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.FormListContext = void 0;

require("antd/es/form/style");

var _form = _interopRequireDefault(require("antd/es/form"));

require("antd/es/config-provider/style");

var _configProvider = _interopRequireDefault(require("antd/es/config-provider"));

require("antd/es/button/style");

var _button = _interopRequireDefault(require("antd/es/button"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

require("antd/es/tooltip/style");

var _tooltip = _interopRequireDefault(require("antd/es/tooltip"));

require("antd/es/spin/style");

var _spin = _interopRequireDefault(require("antd/es/spin"));

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _icons = require("@ant-design/icons");

var _proUtils = require("@ant-design/pro-utils");

var _omit = _interopRequireDefault(require("omit.js"));

var _toArray = _interopRequireDefault(require("rc-util/lib/Children/toArray"));

var _react = _interopRequireWildcard(require("react"));

require("./index.less");

var _warning = require("rc-util/lib/warning");

var _excluded = ["creatorButtonProps", "deleteIconProps", "copyIconProps", "itemContainerRender", "itemRender", "prefixCls", "creatorRecord", "action", "actionGuard", "children", "actionRender", "fields", "meta", "field", "index", "formInstance", "alwaysShowItemLabel", "min", "max", "count"],
    _excluded2 = ["actionRender", "creatorButtonProps", "label", "alwaysShowItemLabel", "tooltip", "creatorRecord", "itemRender", "rules", "itemContainerRender", "copyIconProps", "children", "deleteIconProps", "actionRef", "style", "prefixCls", "actionGuard", "min", "max"];

var FormListContext = /*#__PURE__*/_react.default.createContext({});
/** Antd 自带的toArray 不这次方法，所以需要自己搞一个 */


exports.FormListContext = FormListContext;

var listToArray = function listToArray(children) {
  if (Array.isArray(children)) {
    return children;
  }

  if (typeof children === 'function') {
    return [children];
  }

  return (0, _toArray.default)(children);
};

var ProFormListItem = function ProFormListItem(props) {
  var _formInstance$getFiel;

  var creatorButtonProps = props.creatorButtonProps,
      deleteIconProps = props.deleteIconProps,
      copyIconProps = props.copyIconProps,
      itemContainerRender = props.itemContainerRender,
      itemRender = props.itemRender,
      prefixCls = props.prefixCls,
      creatorRecord = props.creatorRecord,
      action = props.action,
      actionGuard = props.actionGuard,
      children = props.children,
      actionRender = props.actionRender,
      fields = props.fields,
      meta = props.meta,
      field = props.field,
      index = props.index,
      formInstance = props.formInstance,
      alwaysShowItemLabel = props.alwaysShowItemLabel,
      min = props.min,
      max = props.max,
      count = props.count,
      rest = (0, _objectWithoutProperties2.default)(props, _excluded);
  var listContext = (0, _react.useContext)(FormListContext);

  var _useState = (0, _react.useState)(false),
      _useState2 = (0, _slicedToArray2.default)(_useState, 2),
      loadingRemove = _useState2[0],
      setLoadingRemove = _useState2[1];

  var _useState3 = (0, _react.useState)(false),
      _useState4 = (0, _slicedToArray2.default)(_useState3, 2),
      loadingCopy = _useState4[0],
      setLoadingCopy = _useState4[1];

  var childrenArray = listToArray(children).map(function (childrenItem) {
    if (typeof childrenItem === 'function') {
      return childrenItem === null || childrenItem === void 0 ? void 0 : childrenItem(field, index, action);
    }

    return childrenItem;
  }).map(function (childrenItem) {
    if ( /*#__PURE__*/_react.default.isValidElement(childrenItem)) {
      return /*#__PURE__*/_react.default.cloneElement(childrenItem, (0, _objectSpread2.default)({
        key: childrenItem.key || (0, _proUtils.nanoid)()
      }, childrenItem === null || childrenItem === void 0 ? void 0 : childrenItem.props));
    }

    return childrenItem;
  });
  var copyIcon = (0, _react.useMemo)(function () {
    /** 复制按钮的配置 */
    if (!copyIconProps || max === count) return null;
    var _copyIconProps$Icon = copyIconProps.Icon,
        Icon = _copyIconProps$Icon === void 0 ? _icons.CopyOutlined : _copyIconProps$Icon,
        tooltipText = copyIconProps.tooltipText;
    return /*#__PURE__*/_react.default.createElement(_tooltip.default, {
      title: tooltipText,
      key: "copy"
    }, /*#__PURE__*/_react.default.createElement(_spin.default, {
      spinning: loadingCopy
    }, /*#__PURE__*/_react.default.createElement(Icon, {
      className: "".concat(prefixCls, "-action-icon action-copy"),
      onClick: /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee() {
        return _regenerator.default.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                setLoadingCopy(true);
                _context.next = 3;
                return action.add(formInstance === null || formInstance === void 0 ? void 0 : formInstance.getFieldValue([listContext.listName, rest.name, field.name].filter(function (item) {
                  return item !== undefined;
                }).flat(1)));

              case 3:
                setLoadingCopy(false);

              case 4:
              case "end":
                return _context.stop();
            }
          }
        }, _callee);
      }))
    })));
  }, [copyIconProps, max, count, loadingCopy, prefixCls, action, formInstance, listContext.listName, rest.name, field.name]);
  var deleteIcon = (0, _react.useMemo)(function () {
    if (!deleteIconProps || min === count) return null;
    var _deleteIconProps$Icon = deleteIconProps.Icon,
        Icon = _deleteIconProps$Icon === void 0 ? _icons.DeleteOutlined : _deleteIconProps$Icon,
        tooltipText = deleteIconProps.tooltipText;
    return /*#__PURE__*/_react.default.createElement(_tooltip.default, {
      title: tooltipText,
      key: "delete"
    }, /*#__PURE__*/_react.default.createElement(_spin.default, {
      spinning: loadingRemove
    }, /*#__PURE__*/_react.default.createElement(Icon, {
      className: "".concat(prefixCls, "-action-icon action-remove"),
      onClick: /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee2() {
        return _regenerator.default.wrap(function _callee2$(_context2) {
          while (1) {
            switch (_context2.prev = _context2.next) {
              case 0:
                setLoadingRemove(true);
                _context2.next = 3;
                return action.remove(field.name);

              case 3:
                setLoadingRemove(false);

              case 4:
              case "end":
                return _context2.stop();
            }
          }
        }, _callee2);
      }))
    })));
  }, [deleteIconProps, min, count, loadingRemove, prefixCls, action, field.name]);
  var defaultActionDom = (0, _react.useMemo)(function () {
    return [copyIcon, deleteIcon].filter(Boolean);
  }, [copyIcon, deleteIcon]);
  var actions = (actionRender === null || actionRender === void 0 ? void 0 : actionRender(field, action, defaultActionDom, count)) || defaultActionDom;
  var dom = actions.length > 0 ? /*#__PURE__*/_react.default.createElement("div", {
    className: "".concat(prefixCls, "-action")
  }, actions) : null;
  var options = {
    field: field,
    index: index,
    record: formInstance === null || formInstance === void 0 ? void 0 : (_formInstance$getFiel = formInstance.getFieldValue) === null || _formInstance$getFiel === void 0 ? void 0 : _formInstance$getFiel.call(formInstance, [listContext.listName, rest.name, field.name].filter(function (item) {
      return item !== undefined;
    }).flat(1)),
    fields: fields,
    operation: action,
    meta: meta
  };
  var itemContainer = (itemContainerRender === null || itemContainerRender === void 0 ? void 0 : itemContainerRender(childrenArray, options)) || childrenArray;

  var contentDom = (itemRender === null || itemRender === void 0 ? void 0 : itemRender({
    listDom: /*#__PURE__*/_react.default.createElement("div", {
      className: "".concat(prefixCls, "-container")
    }, itemContainer),
    action: dom
  }, options)) || /*#__PURE__*/_react.default.createElement("div", {
    className: "".concat(prefixCls, "-item").concat(alwaysShowItemLabel ? " ".concat(prefixCls, "-item-show-label") : ''),
    style: {
      display: 'flex',
      alignItems: 'flex-end'
    }
  }, /*#__PURE__*/_react.default.createElement("div", {
    className: "".concat(prefixCls, "-container")
  }, itemContainer), dom);

  return /*#__PURE__*/_react.default.createElement(FormListContext.Provider, {
    key: field.name,
    value: (0, _objectSpread2.default)((0, _objectSpread2.default)({}, field), {}, {
      listName: [listContext.listName, rest.originName, field.name].filter(function (item) {
        return item !== undefined;
      }).flat(1)
    })
  }, contentDom);
};

var ProFormListContainer = function ProFormListContainer(props) {
  var creatorButtonProps = props.creatorButtonProps,
      prefixCls = props.prefixCls,
      children = props.children,
      creatorRecord = props.creatorRecord,
      action = props.action,
      fields = props.fields,
      actionGuard = props.actionGuard,
      max = props.max;
  var fieldKeyMap = (0, _react.useRef)(new Map());

  var _useState5 = (0, _react.useState)(false),
      _useState6 = (0, _slicedToArray2.default)(_useState5, 2),
      loading = _useState6[0],
      setLoading = _useState6[1];

  var uuidFields = (0, _react.useMemo)(function () {
    return fields.map(function (field) {
      var _fieldKeyMap$current, _fieldKeyMap$current3;

      if (!((_fieldKeyMap$current = fieldKeyMap.current) === null || _fieldKeyMap$current === void 0 ? void 0 : _fieldKeyMap$current.has(field.key.toString()))) {
        var _fieldKeyMap$current2;

        (_fieldKeyMap$current2 = fieldKeyMap.current) === null || _fieldKeyMap$current2 === void 0 ? void 0 : _fieldKeyMap$current2.set(field.key.toString(), (0, _proUtils.nanoid)());
      }

      var uuid = (_fieldKeyMap$current3 = fieldKeyMap.current) === null || _fieldKeyMap$current3 === void 0 ? void 0 : _fieldKeyMap$current3.get(field.key.toString());
      return (0, _objectSpread2.default)((0, _objectSpread2.default)({}, field), {}, {
        uuid: uuid
      });
    });
  }, [fields]);
  /**
   * 根据行为守卫包装action函数
   */

  var wrapperAction = (0, _react.useMemo)(function () {
    var wrapAction = (0, _objectSpread2.default)({}, action);
    var count = uuidFields.length;
    Object.keys(action).forEach(function (key) {
      switch (key) {
        case 'add':
          wrapAction.add = /*#__PURE__*/function () {
            var _ref3 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee3(defaultValue, insertIndex) {
              var _actionGuard$beforeAd;

              var needAdd;
              return _regenerator.default.wrap(function _callee3$(_context3) {
                while (1) {
                  switch (_context3.prev = _context3.next) {
                    case 0:
                      if (actionGuard === null || actionGuard === void 0 ? void 0 : actionGuard.beforeAddRow) {
                        _context3.next = 3;
                        break;
                      }

                      action.add(defaultValue, insertIndex);
                      return _context3.abrupt("return");

                    case 3:
                      _context3.next = 5;
                      return (_actionGuard$beforeAd = actionGuard.beforeAddRow) === null || _actionGuard$beforeAd === void 0 ? void 0 : _actionGuard$beforeAd.call(actionGuard, defaultValue, insertIndex, count);

                    case 5:
                      needAdd = _context3.sent;

                      if (needAdd) {
                        _context3.next = 8;
                        break;
                      }

                      return _context3.abrupt("return");

                    case 8:
                      action.add(defaultValue, insertIndex);

                    case 9:
                    case "end":
                      return _context3.stop();
                  }
                }
              }, _callee3);
            }));

            return function (_x, _x2) {
              return _ref3.apply(this, arguments);
            };
          }();

          break;

        case 'remove':
          wrapAction.remove = /*#__PURE__*/function () {
            var _ref4 = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee4(idx) {
              var _actionGuard$beforeRe;

              var needRemove;
              return _regenerator.default.wrap(function _callee4$(_context4) {
                while (1) {
                  switch (_context4.prev = _context4.next) {
                    case 0:
                      if (actionGuard === null || actionGuard === void 0 ? void 0 : actionGuard.beforeRemoveRow) {
                        _context4.next = 3;
                        break;
                      }

                      action.remove(idx);
                      return _context4.abrupt("return");

                    case 3:
                      _context4.next = 5;
                      return (_actionGuard$beforeRe = actionGuard.beforeRemoveRow) === null || _actionGuard$beforeRe === void 0 ? void 0 : _actionGuard$beforeRe.call(actionGuard, idx, count);

                    case 5:
                      needRemove = _context4.sent;

                      if (needRemove) {
                        _context4.next = 8;
                        break;
                      }

                      return _context4.abrupt("return");

                    case 8:
                      action.remove(idx);

                    case 9:
                    case "end":
                      return _context4.stop();
                  }
                }
              }, _callee4);
            }));

            return function (_x3) {
              return _ref4.apply(this, arguments);
            };
          }();

          break;
      }
    });
    return wrapAction;
  }, [action, actionGuard, uuidFields]);
  var creatorButton = (0, _react.useMemo)(function () {
    if (creatorButtonProps === false || uuidFields.length === max) return null;

    var _ref5 = creatorButtonProps || {},
        _ref5$position = _ref5.position,
        position = _ref5$position === void 0 ? 'bottom' : _ref5$position,
        _ref5$creatorButtonTe = _ref5.creatorButtonText,
        creatorButtonText = _ref5$creatorButtonTe === void 0 ? '添加一行数据' : _ref5$creatorButtonTe;

    return /*#__PURE__*/_react.default.createElement(_button.default, (0, _extends2.default)({
      className: "".concat(prefixCls, "-creator-button-").concat(position),
      type: "dashed",
      loading: loading,
      block: true,
      icon: /*#__PURE__*/_react.default.createElement(_icons.PlusOutlined, null)
    }, (0, _omit.default)(creatorButtonProps || {}, ['position', 'creatorButtonText']), {
      onClick: /*#__PURE__*/(0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee5() {
        var index;
        return _regenerator.default.wrap(function _callee5$(_context5) {
          while (1) {
            switch (_context5.prev = _context5.next) {
              case 0:
                setLoading(true); // 如果不是从顶部开始添加，则插入的索引为当前行数

                index = uuidFields.length; // 如果是顶部，加到第一个，如果不是，为空就是最后一个

                if (position === 'top') index = 0;
                _context5.next = 5;
                return wrapperAction.add((0, _proUtils.runFunction)(creatorRecord), index);

              case 5:
                setLoading(false);

              case 6:
              case "end":
                return _context5.stop();
            }
          }
        }, _callee5);
      }))
    }), creatorButtonText);
  }, [creatorButtonProps, prefixCls, loading, wrapperAction, creatorRecord, uuidFields, max]);
  return /*#__PURE__*/_react.default.createElement("div", {
    style: {
      width: 'max-content',
      maxWidth: '100%'
    }
  }, creatorButtonProps !== false && (creatorButtonProps === null || creatorButtonProps === void 0 ? void 0 : creatorButtonProps.position) === 'top' && creatorButton, uuidFields.map(function (field, index) {
    return /*#__PURE__*/_react.default.createElement(ProFormListItem, (0, _extends2.default)({}, props, {
      key: field.uuid,
      field: field,
      index: index,
      action: wrapperAction,
      count: uuidFields.length
    }), children);
  }), creatorButtonProps !== false && (creatorButtonProps === null || creatorButtonProps === void 0 ? void 0 : creatorButtonProps.position) !== 'top' && creatorButton);
};

var ProFormList = function ProFormList(_ref7) {
  var actionRender = _ref7.actionRender,
      creatorButtonProps = _ref7.creatorButtonProps,
      label = _ref7.label,
      alwaysShowItemLabel = _ref7.alwaysShowItemLabel,
      tooltip = _ref7.tooltip,
      creatorRecord = _ref7.creatorRecord,
      itemRender = _ref7.itemRender,
      rules = _ref7.rules,
      itemContainerRender = _ref7.itemContainerRender,
      _ref7$copyIconProps = _ref7.copyIconProps,
      copyIconProps = _ref7$copyIconProps === void 0 ? {
    Icon: _icons.CopyOutlined,
    tooltipText: '复制此行'
  } : _ref7$copyIconProps,
      children = _ref7.children,
      _ref7$deleteIconProps = _ref7.deleteIconProps,
      deleteIconProps = _ref7$deleteIconProps === void 0 ? {
    Icon: _icons.DeleteOutlined,
    tooltipText: '删除此行'
  } : _ref7$deleteIconProps,
      actionRef = _ref7.actionRef,
      style = _ref7.style,
      prefixCls = _ref7.prefixCls,
      actionGuard = _ref7.actionGuard,
      min = _ref7.min,
      max = _ref7.max,
      rest = (0, _objectWithoutProperties2.default)(_ref7, _excluded2);
  var actionRefs = (0, _react.useRef)();
  var context = (0, _react.useContext)(_configProvider.default.ConfigContext);
  var listContext = (0, _react.useContext)(FormListContext);
  var baseClassName = context.getPrefixCls('pro-form-list'); // 处理 list 的嵌套

  var name = (0, _react.useMemo)(function () {
    if (listContext.name === undefined) {
      return [rest.name].flat(1);
    }

    return [listContext.name, rest.name].flat(1);
  }, [listContext.name, rest.name]); // eslint-disable-next-line react-hooks/exhaustive-deps

  (0, _react.useImperativeHandle)(actionRef, function () {
    return actionRefs.current;
  }, [actionRefs.current]);
  var proFormContext = (0, _react.useContext)(_proUtils.ProFormContext);
  (0, _react.useEffect)(function () {
    (0, _warning.noteOnce)(!!proFormContext.formRef, "ProFormList \u5FC5\u987B\u8981\u653E\u5230 ProForm \u4E2D,\u5426\u5219\u4F1A\u9020\u6210\u884C\u4E3A\u5F02\u5E38\u3002");
    (0, _warning.noteOnce)(!!proFormContext.formRef, "Proformlist must be placed in ProForm, otherwise it will cause abnormal behavior.");
  }, [proFormContext.formRef]);
  if (!proFormContext.formRef) return null;
  return /*#__PURE__*/_react.default.createElement("div", {
    className: baseClassName,
    style: style
  }, /*#__PURE__*/_react.default.createElement(_form.default.Item, (0, _extends2.default)({
    label: label,
    prefixCls: prefixCls,
    tooltip: tooltip,
    style: style
  }, rest, {
    name: undefined,
    rules: undefined
  }), /*#__PURE__*/_react.default.createElement(_form.default.List, (0, _extends2.default)({
    rules: rules
  }, rest, {
    name: name
  }), function (fields, action, meta) {
    // 将 action 暴露给外部
    actionRefs.current = action;
    return /*#__PURE__*/_react.default.createElement(_react.default.Fragment, null, /*#__PURE__*/_react.default.createElement(ProFormListContainer, {
      name: name,
      originName: rest.name,
      copyIconProps: copyIconProps,
      deleteIconProps: deleteIconProps,
      formInstance: proFormContext.formRef.current,
      prefixCls: baseClassName,
      meta: meta,
      fields: fields,
      itemContainerRender: itemContainerRender,
      itemRender: itemRender,
      creatorButtonProps: creatorButtonProps,
      creatorRecord: creatorRecord,
      actionRender: actionRender,
      action: action,
      actionGuard: actionGuard,
      alwaysShowItemLabel: alwaysShowItemLabel,
      min: min,
      max: max,
      count: fields.length
    }, children), /*#__PURE__*/_react.default.createElement(_form.default.ErrorList, {
      errors: meta.errors
    }));
  })));
};

var _default = ProFormList;
exports.default = _default;